extends layout

block content
	h1= title

	- if (typeof userList !== 'undefined') {
		div#userList
			ul
				each user in userList
					li
						a(href='/map/' + user.id)=user.name
		
	- }

	div#map(style="height: 100vh; width: 100%")
		script.
			function initMap() {
			var maldives = {lat: 4.178044, lng: 73.505828};
			var center = maldives;
			if (selectedUser !== null) {
				console.log('selectedUser: ', selectedUser)
				var selectedUser = !{JSON.stringify(selectedUser).replace(/<\//g, '<\\/')};
				center = (selectedUser) ? {lat: selectedUser.lastLocation.latitude, lng: selectedUser.lastLocation.longitude} : center
			}

			//- var markerArray = [];
			console.log('Centered on: ', center)
			
			var map = new google.maps.Map(document.getElementById('map'), {
				zoom: 13,
				center: center
			});

			//- poly = new google.maps.Polyline({
			//- 	strokeColor: 'blue',
			//- 	strokeOpacity: 0.8,
			//- 	strokeWeight: 2
			//- });
			//- poly.setMap(map);

			var userList = !{JSON.stringify(userList).replace(/<\//g, '<\\/')};
			var paths = !{JSON.stringify(paths).replace(/<\//g, '<\\/')};

			if(paths !== null){
				console.log('PATHS EXIST', paths)

				let polyArr = [];
				paths.forEach((pathObj) => {
					console.log('pathObj:', pathObj);
					var col = '#'+Math.floor(Math.random()*16777215).toString(16);
					//- console.log('This is the path: ', p)
					let poly = new google.maps.Polyline({
						strokeColor: col,
						strokeOpacity: 0.8,
						strokeWeight: 6
					});

					google.maps.event.addListener(poly, "mouseover", () => {
						console.log('Hovering over polyline');
						poly.setOptions({
							strokeOpacity: 1
						})
						console.log(poly.getPath().getArray().toString());
					})

					google.maps.event.addListener(poly, "mouseout", () => {
						console.log('Mouseout of polyline');
						poly.setOptions({
							strokeOpacity: 0.8
						})
					})

					polyArr.push(poly);

					pathObj.path.forEach((node) => {
						//- console.log('node:', node);
						let pArr = poly.getPath();
						//- console.log('Node', node)
						let latLng = new google.maps.LatLng(node.latitude, node.longitude);
						pArr.push(latLng)
					})
				})

				polyArr.forEach((polyLine) => {
					console.log('Added polyline')
					polyLine.setMap(map)
				})

			} else { console.log('No paths') }

			userList.forEach((user) => {
				var latLng = new google.maps.LatLng(user.lastLocation.latitude, user.lastLocation.longitude);
				var marker = new google.maps.Marker({
					position: latLng,
					map: map
				});
			});

			  //- var marker = new google.maps.Marker({
			  //-   position: {lat: x.lastLocation.latitude, lng: 73.505828},
			  //-   map: map
			  //- });
			}

		script(async, defer, src="https://maps.googleapis.com/maps/api/js?key=AIzaSyC0g37AIh4J1U1YeO_cN9g0gxnv6YnreYQ&callback=initMap")
